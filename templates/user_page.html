<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ profile_user.username }}'s Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 9999px;
      border: 4px solid #6366f1;
    }
  </style>
</head>
<body class="bg-gray-100">

  <div class="max-w-5xl mx-auto p-6 bg-white mt-10 rounded-lg shadow-lg">
    <!-- Profile Header -->
    <div class="flex flex-col items-center">
      <img id="avatar-preview" src="{{ profile_user.profile_pic_url }}" alt="Profile Picture" class="profile-avatar mb-4 shadow">
      <h1 class="text-3xl font-bold">{{ profile_user.username }}</h1>
      <p class="text-gray-600 mt-1 text-center max-w-lg">{{ profile_user.profile_bio }}</p>
      {% if profile_user.discord_link %}
        <p class="text-sm text-indigo-600 mt-1"><strong>Discord:</strong> <a href="{{ profile_user.discord_link }}" target="_blank">{{ profile_user.discord_link }}</a></p>
      {% endif %}
      {% if profile_user.email %}
        <p class="text-sm text-gray-500 mt-1"><strong>Email:</strong> {{ profile_user.email }}</p>
      {% endif %}
    </div>

    <!-- Stats Section -->
    <div class="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
      <div class="p-4 bg-gray-50 rounded shadow">
        <h3 class="text-lg font-semibold text-gray-700">Projects</h3>
        <p class="text-indigo-600 text-xl font-bold">{{ profile_user.stats.totalProjects }}</p>
      </div>
      <div class="p-4 bg-gray-50 rounded shadow">
        <h3 class="text-lg font-semibold text-gray-700">Views</h3>
        <p class="text-indigo-600 text-xl font-bold">{{ profile_user.stats.totalViews }}</p>
      </div>
      <div class="p-4 bg-gray-50 rounded shadow">
        <h3 class="text-lg font-semibold text-gray-700">Likes</h3>
        <p class="text-indigo-600 text-xl font-bold">{{ profile_user.stats.totalLikes }}</p>
      </div>
      <div class="p-4 bg-gray-50 rounded shadow">
        <h3 class="text-lg font-semibold text-gray-700">Favorites</h3>
        <p class="text-indigo-600 text-xl font-bold">{{ profile_user.stats.totalFavorites }}</p>
      </div>
    </div>

    <!-- Edit Form (Visible to Owner) -->
    {% if is_owner %}
    <form id="edit-form" class="mt-10 space-y-4" enctype="multipart/form-data">
      <h2 class="text-xl font-bold mb-2">Edit Profile</h2>
      <div>
        <label class="block font-medium">Bio</label>
        <textarea name="profile_bio" class="w-full p-2 border rounded" rows="3">{{ profile_user.profile_bio }}</textarea>
      </div>
      <div>
        <label class="block font-medium">Discord Link</label>
        <input type="text" name="discord_link" class="w-full p-2 border rounded" value="{{ profile_user.discord_link }}">
      </div>
      <div>
        <label class="block font-medium">Upload Profile Picture</label>
        <input type="file" name="profile_pic" accept="image/*" onchange="previewImage(event)">
      </div>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded font-semibold">Save Changes</button>
      <p id="form-message" class="text-green-600 hidden mt-2">Profile updated successfully!</p>
    </form>
    {% endif %}

    <!-- Projects Section -->
    <div class="mt-12">
      <h2 class="text-2xl font-bold mb-4 text-center">Projects ({{ profile_user.stats.totalProjects }})</h2>
      {% if profile_user.projects %}
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for project in profile_user.projects %}
          <div class="bg-gray-50 rounded shadow p-4 flex flex-col justify-between">
            <img src="{{ project.image }}" alt="Project Image" class="w-full h-48 object-cover rounded mb-3" onerror="this.src='/images/No%20Cover%20Available'">
            <div>
              <h3 class="text-lg font-semibold">{{ project.title }}</h3>
              <p class="text-sm text-gray-600 mt-1">Views: {{ project.stats.views }} | Likes: {{ project.stats.loves }} | Favorites: {{ project.stats.favorites }}</p>
              <a href="{{ project.link }}" target="_blank" class="inline-block mt-3 bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded text-sm font-semibold">View Project</a>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-center text-gray-500">No public projects yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- JS -->
  <script>
    const previewImage = (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById('avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    };

    const form = document.getElementById('edit-form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const res = await fetch(`/api/edit_profile/{{ profile_user.username }}`, {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        const msgEl = document.getElementById('form-message');
        if (res.ok) {
          msgEl.classList.remove('hidden');
          msgEl.textContent = "Profile updated successfully!";
        } else {
          msgEl.classList.remove('hidden');
          msgEl.classList.replace('text-green-600', 'text-red-600');
          msgEl.textContent = result.error || "Something went wrong.";
        }
      });
    }
  </script>
</body>
</html>
