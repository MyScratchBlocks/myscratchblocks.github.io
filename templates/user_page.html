<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ profile_user.username }}'s Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 960px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            margin-bottom: 1.5rem;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #6366f1; /* Tailwind indigo-500 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .profile-name {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            margin-top: 1rem;
            color: #1a202c; /* Tailwind gray-900 */
        }
        .profile-bio {
            font-size: 1rem; /* text-base */
            color: #4a5568; /* Tailwind gray-700 */
            text-align: center;
            margin-top: 0.5rem;
        }
        .edit-button {
            background-color: #6366f1; /* Tailwind indigo-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }
        .edit-button:hover {
            background-color: #4f46e5; /* Tailwind indigo-600 */
        }
        .section-title {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1a202c;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .project-card {
            background-color: #f8fafc; /* Tailwind slate-50 */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        .project-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }
        .project-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .project-name {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1a202c;
            margin-bottom: 0.5rem;
        }
        .project-author {
            font-size: 0.9rem; /* text-sm */
            color: #6b7280; /* Tailwind gray-500 */
            margin-bottom: 0.75rem;
        }
        .project-popularity {
            font-size: 0.9rem;
            color: #4a5568;
            margin-top: auto; /* Pushes popularity to the bottom */
        }
        .project-link {
            display: inline-block;
            background-color: #4ade80; /* Tailwind green-400 */
            color: #166534; /* Tailwind green-800 */
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            margin-top: 1rem;
            text-decoration: none; /* Remove underline */
            transition: background-color 0.3s ease;
        }
        .project-link:hover {
            background-color: #22c55e; /* Tailwind green-500 */
        }
        .loading-message, .error-message, .no-projects-message {
            text-align: center;
            font-size: 1.125rem;
            color: #6b7280;
            padding: 2rem;
            grid-column: 1 / -1; /* Make messages span all columns */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            max-width: 400px;
            text-align: center;
        }
        .message-box-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
        }
        .message-box-content {
            font-size: 1rem;
            color: #4a5568;
        }
        .message-box-button {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .message-box-button:hover {
            background-color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="container">
        <div class="profile-header">
            <img id="profile-avatar" class="profile-avatar" src="{{ profile_user.profile_pic_url }}" alt="User Avatar">
            <h1 id="profile-name" class="profile-name">{{ profile_user.username }}</h1>
            <p id="profile-bio" class="profile-bio">{{ profile_user.profile_bio }}</p>
            <button id="edit-profile-btn" class="edit-button {% if not is_owner %}hidden{% endif %}">Edit Profile</button>
        </div>

        <h2 class="section-title">My Projects ({{ profile_user.totalProjects }})</h2>
        <div id="projects-container" class="projects-grid">
            <p class="loading-message" id="loading-message">Loading projects...</p>
            <p class="error-message hidden" id="error-message">Failed to load projects. Please try again later.</p>
            <p class="no-projects-message hidden" id="no-projects-message">No projects found for this user.</p>
        </div>
    </div>

    <div id="message-box" class="message-box">
        <h3 id="message-box-title" class="message-box-title"></h3>
        <p id="message-box-content" class="message-box-content"></p>
        <button id="message-box-button" class="message-box-button">OK</button>
    </div>

    <script type="module">
        // JavaScript variables injected by Flask
        const profileOwner = "{{ profile_user.username }}";
        const loggedInUsername = "{{ logged_in_username if logged_in_username is not none else '' }}"; // Get from Flask session
        const isOwner = {{ 'true' if is_owner else 'false' }};

        const profileNameElement = document.getElementById('profile-name');
        const profileBioElement = document.getElementById('profile-bio');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const projectsContainer = document.getElementById('projects-container');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const noProjectsMessage = document.getElementById('no-projects-message');

        // Function to display a custom message box
        function showMessageBox(title, message) {
            const msgBox = document.getElementById('message-box');
            document.getElementById('message-box-title').textContent = title;
            document.getElementById('message-box-content').textContent = message;
            msgBox.style.display = 'flex';
            document.getElementById('message-box-button').onclick = () => {
                msgBox.style.display = 'none';
            };
        }

        // Conditional display and functionality for edit button
        if (isOwner) {
            editProfileBtn.classList.remove('hidden');
            editProfileBtn.onclick = () => {
                showMessageBox("Edit Profile", "You are the owner! You can now edit your profile.");
                // TODO: Implement actual in-place editing or redirect to an edit form
            };
        } else {
            editProfileBtn.classList.add('hidden');
        }

        // Function to fetch and display projects
        async function fetchAndDisplayProjects() {
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            noProjectsMessage.classList.add('hidden');
            projectsContainer.innerHTML = ''; // Clear previous projects

            try {
                // Fetch projects from the external API
                const response = await fetch('https://editor-compiler.onrender.com/api/projects');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.projects && Array.isArray(data.projects)) {
                    // Filter projects by the profile owner
                    const ownedProjects = data.projects.filter(project => project.author === profileOwner);

                    // Sort projects by popularity in descending order
                    ownedProjects.sort((a, b) => b.popularity - a.popularity);

                    if (ownedProjects.length === 0) {
                        noProjectsMessage.classList.remove('hidden');
                    } else {
                        ownedProjects.forEach(project => {
                            const projectCard = document.createElement('div');
                            projectCard.className = 'project-card';
                            projectCard.innerHTML = `
                                <img class="project-image" src="${project.image}" alt="${project.name}" onerror="this.onerror=null;this.src='/images/No%20Cover%20Available';">
                                <div class="project-content">
                                    <h3 class="project-name">${project.name}</h3>
                                    <p class="project-author">By: ${project.author}</p>
                                    <a href="${project.link}" target="_blank" class="project-link">View Project</a>
                                </div>
                            `;
                            projectsContainer.appendChild(projectCard);
                        });
                    }
                } else {
                    throw new Error("Invalid data format received from API.");
                }
            } catch (error) {
                console.error("Error fetching projects:", error);
                errorMessage.classList.remove('hidden');
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        // Call the function to fetch and display projects when the page loads
        window.onload = fetchAndDisplayProjects;

        // You might want to remove these localStorage manipulations in production.
        // For testing purposes:
        // localStorage.setItem('username', 'kRxZy_kRxZy'); // Simulate logged-in as owner
        // localStorage.setItem('username', 'another_user'); // Simulate logged-in as another user
        // localStorage.removeItem('username'); // Simulate not logged in
    </script>
</body>
      </html>
