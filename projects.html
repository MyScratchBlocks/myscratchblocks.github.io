<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://kit.fontawesome.com/1373677f05.js" crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyScratchBlocks - Project Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@octokit/core@5.0.0/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@octokit/auth-token@4.0.0/dist/index.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    /* Reset and global styles */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
      color: #334155;
      margin: 0;
      padding: 0;
    }

    iframe {
      border: 8px solid #0c99d5;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(12, 153, 213, 0.5);
      width: 100%;
      height: 600px;
      background: #e0f7fa;
      display: block;
      margin-bottom: 1.5rem;
    }

    /* Buttons */
    button {
      background-color: #04AA6D;
      color: white;
      padding: 14px 20px;
      margin: 8px 0;
      border: none;
      cursor: pointer;
      width: 100%;
      opacity: 0.9;
      font-size: 16px;
      border-radius: 6px;
      transition: opacity 0.3s ease;
      user-select: none;
    }

    button:hover {
      opacity: 1;
    }

    /* Cancel and delete buttons in modal */
    .cancelbtn, .deletebtn {
      float: left;
      width: 48%;
      margin: 1%;
      padding: 12px 0;
      font-weight: 600;
      border-radius: 6px;
      user-select: none;
    }

    .cancelbtn {
      background-color: #ccc;
      color: black;
    }

    .deletebtn {
      background-color: #f44336;
    }

    /* Container for modal content */
    .container {
      padding: 16px;
      text-align: center;
    }

    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 50;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.6);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
      max-width: 90%;
      width: 400px;
      margin: auto;
      border: 1px solid #888;
      position: relative;
    }

    /* Modal close button */
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 32px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      user-select: none;
    }

    .close:hover,
    .close:focus {
      color: #f44336;
    }

    /* Clearfix for floats */
    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }

    /* Responsive adjustments */
    @media screen and (max-width: 300px) {
      .cancelbtn, .deletebtn {
        width: 100%;
        margin: 0 0 10px 0;
        float: none;
      }
    }

    /* Disabled button style */
    .disabled-btn {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body class="antialiased">

  <header class="bg-white shadow-sm py-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <a href="#" class="flex items-center space-x-2 text-2xl font-bold text-indigo-600">
        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-6h-2v6zm0-8h2V7h-2v2z"/>
        </svg>
        <span>MyScratchBlocks</span>
      </a>
      <nav class="hidden md:flex space-x-6">
        <a href="/" class="text-gray-600 hover:text-indigo-600 font-medium">Home</a>
        <a href="/#features" class="text-gray-600 hover:text-indigo-600 font-medium">Features</a>
        <a href="/#block-ideas" class="text-gray-600 hover:text-indigo-600 font-medium">Block Ideas</a>
        <a href="/#project-ideas" class="text-gray-600 hover:text-indigo-600 font-medium">Project Ideas</a>
        <a href="/#featured-projects" class="text-gray-600 hover:text-indigo-600 font-medium">Featured Projects</a>
        <a href="/#access" class="text-gray-600 hover:text-indigo-600 font-medium">Access</a>
        <a href="/#community" class="text-gray-600 hover:text-indigo-600 font-medium">Community</a>
        <a href="/#about" class="text-gray-600 hover:text-indigo-600 font-medium">About</a>
        <a id="account" href="/account" class="text-gray-600 hover:text-indigo-600 font-medium">Account</a>
      </nav>
    </div>
  </header>

  <section id="featured-projects" class="py-16 bg-gray-100">
    <div class="container mx-auto px-4">
      <iframe id="id-frame" src="#" title="Project Viewer"></iframe>

      <div id="project-meta" class="bg-white p-6 rounded-lg shadow-md">
        <div id="meta-loading" class="text-sm text-gray-500">Loading project metadata...</div>
        <div id="meta-error" class="hidden text-sm text-red-600">Failed to load metadata. The project may not exist, or there is a temp errror on our end.</div>
        <div id="meta-content" class="hidden">
          <center><h2 class="text-2xl font-bold text-indigo-700 mb-2" id="meta-title"></h2></center>
          <p class="text-gray-700 mb-4" id="meta-description"></p>
          <p class="text-gray-600 mb-4" id="meta-instructions"></p>
          <div class="mb-4">
            <p class="text-sm text-gray-500"><i class="fa-solid fa-user" style="color: #63E6BE;" aria-hidden="true"></i><strong>Main Coder:</strong> <span id="meta-author"></span></p>
            <p class="text-sm text-gray-500"><i class="fa-solid fa-calendar" style="color: #63E6BE;" aria-hidden="true"></i><strong> Created:</strong> <span id="meta-date"></span></p>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-4">
            <div>
              <i class="fa-solid fa-eye" style="color: #63E6BE;" aria-hidden="true"></i>
              <p class="text-lg font-semibold text-indigo-600" id="meta-views">0</p>
              <p class="text-sm text-gray-500">Views</p>
            </div>
            <div>
              <i class="fa-solid fa-arrow-up" style="color: #63E6BE;" aria-hidden="true"></i>
              <p class="text-lg font-semibold text-blue-600" id="meta-loves">0</p>
              <p class="text-sm text-gray-500">Upvotes</p>
            </div>
            <div>
              <i class="fa-solid fa-star" style="color: #63E6BE;" aria-hidden="true"></i>
              <p class="text-lg font-semibold text-yellow-500" id="meta-favorites">0</p>
              <p class="text-sm text-gray-500">Favorites</p>
            </div>
            <div>
              <i class="fa-solid fa-clone" style="color: #63E6BE;" aria-hidden="true"></i>
              <p class="text-lg font-semibold text-green-600" id="meta-remixes">0</p>
              <p class="text-sm text-gray-500">Remixes</p>
            </div>
          </div>

          <div class="flex gap-4 mb-4">
            <button id="like-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg flex-1">
              <i class="fa-solid fa-arrow-up mr-2"></i> Upvote
            </button>
            <button id="fav-btn" class="px-4 py-2 bg-yellow-400 text-white font-semibold rounded-lg flex-1">
              <i class="fa-solid fa-star mr-2"></i> Favourite
            </button>
          </div>

          <div class="flex gap-4">
            <button id="see-inside-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg flex-1">
              <i class="fa-solid fa-code mr-2"></i> See Inside
            </button>
            <button id="remix-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg flex-1">
              <i class="fa-solid fa-clone mr-2"></i> Remix
            </button>
          </div>
        </div>
      </div>

      <button onclick="document.getElementById('id01').style.display='flex'" class="mt-6 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg w-full max-w-xs mx-auto block">
        <i class="fa-solid fa-circle-exclamation"></i> Report Project For Investigation
      </button>

      <div id="id01" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close Modal" aria-label="Close Modal">&times;</span>
        <form id="report-form" class="modal-content" onsubmit="return false;">
          <div class="container">
            <h1 id="modal-title"><i class="fa-solid fa-circle-exclamation"></i> Report This Project</h1>
            <p>Are you sure that you want to report this project for investigation by an admin at MyScratchBlocks? Please don't false report, since it wastes our time.</p>

            <div class="clearfix" style="margin-top: 24px;">
              <button type="button" onclick="document.getElementById('id01').style.display = 'none'" class="cancelbtn" id="cancel-report-btn">Cancel</button>
              <button type="submit" class="deletebtn" id="submit-report-btn"><i class="fa-solid fa-paper-plane"></i> Report</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <section id="comments-section" class="mt-12 bg-white p-6 rounded-lg shadow-md max-w-3xl mx-auto">
    <h3 class="text-xl font-semibold mb-4 text-indigo-700">
      <i class="fa-solid fa-comments mr-2" aria-hidden="true"></i> Comments
    </h3>
    Some rules apply when commenting, for example, following the Community Guidelines and not advertising your projects.
    <div id="comments-list" class="space-y-6">
      <p id="comments-loading" class="text-gray-500">Loading comments...</p>
      <p id="comments-error" class="hidden text-red-600">Failed to load comments.</p>
    </div>
    <form id="comment-form" class="mt-8">
      <textarea id="comment-input" rows="3" placeholder="Add a comment..." required
        class="w-full p-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
      <button type="submit"
        class="mt-2 px-5 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50"
        id="comment-submit"><i class="fa-solid fa-plus mr-2"></i> Post Comment</button>
    </form>
  </section>

  <div id="login-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="login-modal-title">
    <div class="modal-content">
      <h2 id="login-modal-title" class="text-xl font-bold text-red-600 mb-4">Login Required</h2>
      <p class="mb-4">You need to be logged in to use this feature. The good news is that you can use your Scratch Account, no passwords required, and if you don't have one, you can get one for free from Scratch, in seconds.</p>
      <a href="/account" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Login With Scratch</a>
      <button onclick="document.getElementById('login-modal').style.display = 'none'" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded mt-2">Close</button>
    </div>
  </div>

  <script>
    // Get the modal elements
    const reportModal = document.getElementById('id01');
    const loginModal = document.getElementById('login-modal');

    // Make sure both modals are hidden at the start
    reportModal.style.display = 'none';
    loginModal.style.display = 'none';

    const id = window.location.hash.slice(1);
    const iframe = document.getElementById('id-frame');
    const remix = document.getElementById('remix-btn');
        
    iframe.src = `https://myscratchblocks.github.io/scratch-gui/embed#${id}`;

    function closeLoginModal() {
      document.getElementById('login-modal').style.display = 'none';
    }

    function showLoginModal() {
      const loginModal = document.getElementById('login-modal');
      loginModal.style.display = 'flex';
      // Optional: hide the modal after a few seconds if the user doesn't interact
      // setTimeout(() => loginModal.style.display = 'none', 3000); 
    }

    async function fetchMeta() {
      const loading = document.getElementById('meta-loading');
      const error = document.getElementById('meta-error');
      const content = document.getElementById('meta-content');

      try {
        const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${id}/meta`);
        if (!res.ok) throw new Error();
        const meta = await res.json();

        if(meta.author?.username === localStorage.getItem('username')) {
          document.getElementById('see-inside-btn').textContent = '<i class="fa-solid fa-paper-edit"></i> Edit Project';
        }
        document.getElementById('meta-title').textContent = meta.title || 'Untitled Project';
        document.title = meta.title || 'Untitled Project';
        document.getElementById('meta-description').textContent = meta.description || 'No description.';
        document.getElementById('meta-instructions').textContent = meta.instructions || '';
        document.getElementById('meta-author').textContent = meta.author?.username || 'No One';
        document.getElementById('meta-date').textContent = new Date(meta.history?.created).toLocaleDateString();

        document.getElementById('meta-views').textContent = meta.stats?.views ?? 1;
        document.getElementById('meta-loves').textContent = meta.stats?.loves ?? 0;
        document.getElementById('meta-favorites').textContent = meta.stats?.favorites ?? 0;
        document.getElementById('meta-remixes').textContent = meta.stats?.remixes ?? 0;

        if(meta.author?.username === localStorage.getItem('username')) {
          document.getElementById('meta-author').textContent = 'This is you! As the Main Coder, you can configure settings, edit the project, and more'
        }
        
        loading.classList.add('hidden');
        content.classList.remove('hidden');
      } catch {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
      }
    }

    window.onload = async () => {
      fetchMeta();

      const username = localStorage.getItem('username');
      if (username) {
        document.getElementById('account').textContent = username;

        // Always send a view increment (no limiting)
        try {
          const res = await fetch(`https://editor-compiler.onrender.com/api/${id}/views`, { method: 'POST' });
          const json = await res.json();
        } catch(err) {
          console.error('Failed To Record View', err); // Changed from alert to console.error
        }
      }

      document.getElementById('like-btn').addEventListener('click', async () => {
        if (!localStorage.getItem('username')) return showLoginModal();

        try {
          const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${id}/love`, { method: 'POST' });
          if (res.ok) {
            document.getElementById('meta-loves').textContent = parseInt(document.getElementById('meta-loves').textContent) + 1;
          }
        } catch (error) {
            console.error('Error upvoting project:', error);
            alert("Failed to upvote project, please try again!")
        }
      });

      document.getElementById('fav-btn').addEventListener('click', async () => {
        if (!localStorage.getItem('username')) return showLoginModal();

        try {
          const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${id}/favourite`, { method: 'POST' });
          if (res.ok) {
            document.getElementById('meta-favorites').textContent = parseInt(document.getElementById('meta-favorites').textContent) + 1;
          }
        } catch (error) {
            console.error('Error favoriting project:', error);
            alert("Failed to fav project, please try again!")
        }
      });

      document.getElementById('see-inside-btn').addEventListener('click', () => {
        window.location.href = `editor#${id}`;
      });

      remix.addEventListener('click', () => {
        if (!localStorage.getItem('username')) return showLoginModal();
        window.location.href = `editor?remix=${id}`;
      });

      // Comments
      async function fetchComments() {
        try {
          const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${id}/comments`);
          const comments = await res.json();
          const commentsList = document.getElementById('comments-list');
          document.getElementById('comments-loading').style.display = 'none';
          commentsList.innerHTML = ''; // Clear existing comments
          if (comments.length === 0) {
            commentsList.innerHTML = '<p class="text-gray-500">No comments yet. Be the first to comment!</p>';
          } else {
            comments.forEach(c => {
              const div = document.createElement('div');
              div.className = 'border rounded p-3 bg-gray-50';
              div.innerHTML = `<p class="font-semibold text-indigo-700">@${c.user} said:</p><p>${c.text}</p>`;
              commentsList.appendChild(div);
            });
          }
        } catch (error) {
          console.error('Failed to load comments:', error);
          document.getElementById('comments-loading').style.display = 'none';
          document.getElementById('comments-error').classList.remove('hidden');
        }
      }

      fetchComments();

      document.getElementById('comment-form').addEventListener('submit', async e => {
        e.preventDefault();
        const text = document.getElementById('comment-input').value.trim();
        if (!localStorage.getItem('username')) return showLoginModal();
        if (!text) return;

        try {
          const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${id}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, user: localStorage.getItem('username') }) // Send username directly, not an object
          });
          if (res.ok) {
            document.getElementById('comment-input').value = '';
            fetchComments();
          } else {
            alert('Failed to post comment. Please try again.');
          }
        } catch (error) {
          console.error('Error posting comment:', error);
          alert('An error occurred while posting your comment. Please try again.');
        }
      });
    };

    document.getElementById('report-form').addEventListener('submit', async (e) => {
      e.preventDefault(); // Prevent default form submission
      const username = localStorage.getItem('username');
      if (!username) {
          showLoginModal();
          return;
      }
      
      try {
        // Initialize Octokit with the correct authentication method
        const octokit = new Octokit({
            auth: 'github_pat_11A4RWIDA042YSoXsXXZha' + '_UH79juFSUAI9nUCMcq6tASZNPvn67gywETiesve45ycXM7V6MP4JTZhzCSY' // Ensure this token is valid and secure
        });

        const reportBody = `A report has just been made!\nReported Project: https://myscratchblocks.github.io/projects#${id}\nReported By: ${username}`;

        const response = await octokit.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
          owner: 'MyScratchBlocks',
          repo: 'myscratchblocks.github.io',
          issue_number: 8, // Make sure this issue number is correct for your "reports feed"
          body: reportBody,
          headers: {
            'X-GitHub-Api-Version': '2022-11-28'
          }
        });

        const status = response.status

        if (response.status === 201) { // 201 Created is the success status for creating a comment
          document.getElementById('id01').style.display = 'none';
          alert('Project reported successfully!');
        } else {
          alert("Failed to report project. Please try again or report manually at our reports feed. Response Status: ${status} Report Feed: https://github.com/MyScratchBlocks/myscratchblocks.github.io/issues/8");
        }
      } catch (error) {
        console.error('Octokit Error:', error);
        alert("An error occurred while reporting. Please try again or report manually at our reports feed." + error + " Report Feed: https://github.com/MyScratchBlocks/myscratchblocks.github.io/issues/8" + status + "");
      }
    });

async function loadmeta() {
  const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${window.location.hash.substring(1)}/meta`);
  const meta = res.json();
  return meta
}
    
if (loadmeta().author?.username === localStorage.getItem('username')) {
  // Replace title with editable input
  const titleInput = document.createElement('input');
  titleInput.type = 'text';
  titleInput.className = 'text-2xl font-bold text-indigo-700 mb-2 w-full text-center';
  titleInput.value = loadmeta().title || 'Untitled Project';
  titleInput.id = 'editable-title';

  // Replace description with editable textarea
  const descriptionInput = document.createElement('textarea');
  descriptionInput.className = 'w-full p-2 border border-gray-300 rounded mt-2';
  descriptionInput.value = meta.description || 'No description.';
  descriptionInput.id = 'editable-description';

  // Save button
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Save Changes';
  saveBtn.className = 'mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700';
  saveBtn.onclick = async () => {
    const updatedTitle = document.getElementById('editable-title').value.trim();
    const updatedDescription = document.getElementById('editable-description').value.trim();

    try {
      const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${id}/meta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: localStorage.getItem('username'),
          title: updatedTitle,
          description: updatedDescription
        })
      });

      if (res.ok) {
        alert('Project updated successfully!');
      } else {
        alert('Failed to update project.');
      }
    } catch (err) {
      console.error('Update failed:', err);
      alert('Network error updating project.');
    }
  };

  const titleWrapper = document.getElementById('meta-title');
  titleWrapper.replaceWith(titleInput);

  const descWrapper = document.getElementById('meta-description');
  descWrapper.replaceWith(descriptionInput);

  descWrapper.parentNode.insertBefore(saveBtn, descWrapper.nextSibling);
}

  </script>
</body>
</html>
