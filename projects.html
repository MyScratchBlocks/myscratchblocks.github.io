<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Viewer</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    header {
      background: #4a90e2;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }

    iframe {
      width: 100%;
      height: 400px;
      border: none;
      margin-bottom: 1rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btn.secondary {
      background: #ccc;
      color: black;
    }

    .meta {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
    }

    .modal-content input, .modal-content textarea {
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.5rem;
    }

    .error {
      color: red;
      font-weight: bold;
    }

    .loading {
      font-style: italic;
      color: #888;
    }
  </style>
</head>
<body>

<header>
  <h1 id="meta-title">Loading Project...</h1>
</header>

<div class="container">

  <iframe id="id-frame"></iframe>

  <div class="meta">
    <p><strong>Author:</strong> <span id="meta-author">Loading...</span></p>
    <p><strong>Created:</strong> <span id="meta-date">Loading...</span></p>
    <p><strong>Instructions:</strong> <span id="meta-instructions">Loading...</span></p>
    <p><strong>Description:</strong> <span id="meta-description">Loading...</span></p>
  </div>

  <button class="btn" id="see-inside-btn">See Inside</button>
  <button class="btn" id="remix-btn">Remix</button>
  <button class="btn secondary" id="report-btn">Report</button>

  <div id="meta-loading" class="loading">Loading metadata...</div>
  <div id="meta-error" class="error" style="display:none;">Failed to load project metadata.</div>

</div>

<!-- Login Modal -->
<div class="modal" id="login-modal">
  <div class="modal-content">
    <h3>Please log in</h3>
    <p>You need to be logged in to perform this action.</p>
  </div>
</div>

<!-- Report Modal -->
<div class="modal" id="report-modal">
  <div class="modal-content">
    <h3>Report Project</h3>
    <textarea id="report-reason" rows="4" placeholder="Reason for reporting..."></textarea>
    <button class="btn" id="submit-report-btn">Submit</button>
    <button class="btn secondary" id="cancel-report-btn">Cancel</button>
  </div>
</div>

<script>
  const id = window.location.hash.slice(1);
  const iframe = document.getElementById('id-frame');
  const remixBtn = document.getElementById('remix-btn');
  const seeInsideBtn = document.getElementById('see-inside-btn');

  // Set iframe
  iframe.src = `https://myscratchblocks.github.io/scratch-gui/embed#${id}`;

  // Show login modal
  function showLoginModal() {
    const modal = document.getElementById('login-modal');
    modal.style.display = 'flex';
    setTimeout(() => modal.style.display = 'none', 3000);
  }

  // Fetch project metadata
  async function fetchMeta() {
    const loading = document.getElementById('meta-loading');
    const error = document.getElementById('meta-error');

    try {
      const res = await fetch(`https://editor-compiler.onrender.com/api/projects/${id}/meta`);
      if (!res.ok) throw new Error('Failed');
      const meta = await res.json();

      document.getElementById('meta-title').textContent = meta.title || 'Untitled';
      document.title = meta.title || 'Untitled Project';
      document.getElementById('meta-author').textContent = meta.author?.username || 'Unknown';
      document.getElementById('meta-date').textContent = new Date(meta.history?.created).toLocaleDateString();
      document.getElementById('meta-instructions').textContent = meta.instructions || '';
      document.getElementById('meta-description').textContent = meta.description || '';

      if (meta.author?.username === localStorage.getItem('username')) {
        seeInsideBtn.textContent = 'Edit Project';
      }

    } catch {
      error.style.display = 'block';
    } finally {
      loading.style.display = 'none';
    }
  }

  fetchMeta();

  // Report Modal Logic
  const reportBtn = document.getElementById('report-btn');
  const reportModal = document.getElementById('report-modal');
  const cancelReportBtn = document.getElementById('cancel-report-btn');
  const submitReportBtn = document.getElementById('submit-report-btn');

  reportBtn.addEventListener('click', () => {
    const username = localStorage.getItem('username');
    if (!username) {
      showLoginModal();
      return;
    }
    document.getElementById('report-reason').value = '';
    reportModal.style.display = 'flex';
  });

  cancelReportBtn.addEventListener('click', () => {
    reportModal.style.display = 'none';
  });

  submitReportBtn.addEventListener('click', async () => {
    const reason = document.getElementById('report-reason').value.trim();
    const username = localStorage.getItem('username');
    if (!reason || !username) return;

    try {
      await fetch(`https://editor-compiler.onrender.com/${id}/report`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, reason })
      });
      reportModal.style.display = 'none';
    } catch {
      alert('Failed to submit report.');
    }
  });

  // Button redirects
  remixBtn.addEventListener('click', () => {
    const username = localStorage.getItem('username');
    if (!username) {
      showLoginModal();
      return;
    }
    window.location.href = `/editor#remix=${id}`;
  });

  seeInsideBtn.addEventListener('click', () => {
    const username = localStorage.getItem('username');
    if (!username) {
      showLoginModal();
      return;
    }
    window.location.href = `/editor#${id}`;
  });
</script>

</body>
</html>
